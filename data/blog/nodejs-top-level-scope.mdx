---
title: 'Nodejs top-level scope !== global'
h1: 'Nodejs top-level scope !== global'
date: '2022-02-01'
lastmod: '2022-02-01'
draft: false
summary: Nodejs ëŸ°íƒ€ì„ì˜ top-level scopeë¥¼ ì°¾ì•„ì„œ
images: ['/static/images/nestjs-logging/nest-logger.png']
---

ì´ ê¸€ì—ì„œëŠ” `node our.js`ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ ë‚´ë¶€ì ìœ¼ë¡œ `our.js`ë¥¼ ì–´ë–»ê²Œ í•´ì„í•˜ê³  ì»´íŒŒì¼í•˜ê³  ì‹¤í–‰í•˜ëŠ”ì§€ ì‚´í´ë³¸ë‹¤.

## ğŸ‘€ Run `console.log(this === global)`;

ê¶ê¸ˆì¦ì€ ì•„ì£¼ ê°„ë‹¨í•œ js ì½”ë“œë¡œë¶€í„° ì‹œì‘í•œë‹¤. (`node` ì¸í„°í”„ë¦¬í„°ëŠ” top-level scopeê°€ globalì´ë¯€ë¡œ ì•„ë˜ì˜ ëª¨ë“  ì½”ë“œëŠ” `node our.js`ë¡œ ì‹¤í–‰í•´ì•¼ í•œë‹¤. )

```js
// our.js
console.log(this === global) // false
```

í  ... ğŸ¤” ë‹¹ì—°íˆ trueê°€ ë‚˜ì˜¬ ì¤„ ì•Œì•„ì„œ ì¢€ ë†€ë¬ë‹¤. ì´ ê²°ê³¼ì˜ ì´ìœ ëŠ” [Nodejs Docs](https://nodejs.org/api/globals.html#globals_global)ì— ì„¤ëª…ë˜ì–´ ìˆë‹¤.

> ### `global`
>
> Added in: v0.1.27
>
> - [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object) The global namespace object.
>
> In browsers, the top-level scope is the global scope. This means that within the browser `var something` will define a new global variable. In Node.js this is different. **The top-level scope is not the global scope; `var something` inside a Node.js module will be local to that module.**

nodejs í‘œì¤€(=CommonJSì˜ ëª…ì„¸)ì€ `require`ê³¼ `module.exports`ì´ë‹¤. ì¦‰ `node our.js`ë¥¼ ì‹¤í–‰í•˜ë©´, NodejsëŠ” ì´ë¥¼ ë…ë¦½ì ì¸ ì‹¤í–‰ ì˜ì—­ì´ ìˆëŠ” moduleë¡œ ì—¬ê¸°ê³  ì´ë¥¼ v8ë¡œ ì»´íŒŒì¼ í•œ í›„ ì‹¤í–‰í•œë‹¤. ë‹¤ìŒ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ì.

```js
// our.js
function a() {
  return a.caller
}
console.log(a().toString())

/* Result
function (exports, require, module, __filename, __dirname) {
    function a() {
        return a.caller
    }
    console.log(a().toString())
}
*/
```

![image](https://user-images.githubusercontent.com/51329156/152746823-f6017fe5-b803-4c80-8637-8c1104db5ccd.png)

ì‹ ê¸°í•˜ë‹¤... NodejsëŠ” ì°¸ ì‹ ê¸°í•˜ë‹¤...

ì´ìœ ëŠ” **`node our.js`ë¥¼ ì‹¤í–‰í•˜ë©´, NodejsëŠ” ì´ë¥¼ ë…ë¦½ì ì¸ ì‹¤í–‰ ì˜ì—­ì´ ìˆëŠ” moduleë¡œ ì—¬ê¸°ê³  ì´ë¥¼ v8ë¡œ ì»´íŒŒì¼ í•œ í›„ ì‹¤í–‰**í•˜ê¸° ë•Œë¬¸ì´ë‹¤. ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–»ê²Œ `our.js` ì½”ë“œë¥¼ moduleë¡œ ë§Œë“œëŠ”ì§€ ì‚´í´ë³´ì.

## ğŸ” Internal

jsì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ì½œ ìŠ¤íƒì— ìˆëŠ” í•¨ìˆ˜ê°€ ëª¨ë‘ ì¶œë ¥ë˜ê¸° ë•Œë¬¸ì— ë””ë²„ê¹…í•  ë•Œ ìš©ì´í•˜ë‹¤. ì¼ë¶€ëŸ¬ ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œì„œ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë‹¨ê³„ë¥¼ ë”°ë¼ê°€ë³´ì.

```js
// our.js
ErrorCode

/* Result
ErrorCode
^

ReferenceError: ErrorCode is not defined
    at Object.<anonymous> (our.js:1:1)
    at Module._compile (node:internal/modules/cjs/loader:1101:14)
    at Object.Module._extensions..js (node:internal/modules/cjs/loader:1153:10)
    at Module.load (node:internal/modules/cjs/loader:981:32)
    at Function.Module._load (node:internal/modules/cjs/loader:822:12)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)
    at node:internal/main/run_main_module:17:47
*/
```

ëŒ€ëµ ì‚´í´ë³´ë©´ `run_main` -> `Module._load` -> `Module.load` -> `Object.Module._extensions..js` -> `Module._compile` ì˜ ê³¼ì •ì„ ê±°ì¹˜ëŠ” ê²ƒ ê°™ë‹¤. ì½”ë“œëŠ” ëª¨ë‘ [github](https://github.com/nodejs/node/tree/master)ì— ê³µê°œë˜ì–´ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ë©´ì„œ ë¶„ì„í•˜ë©´ ë  ê²ƒ ê°™ë‹¤.

ë¶„ì„ì— ì‚¬ìš©í•œ ë²„ì „ì€ 16.13.2 ì´ë‹¤.

```bash
$ node -v
v16.13.2
```

### [internal/main/run_main_module:](https://github.com/nodejs/node/blob/v16.x/lib/internal/main/run_main_module.js#L17)

```js
...
require('internal/modules/cjs/loader').Module.runMain(process.argv[1]);
```

`Module.runMain()`ì„ ì‹¤í–‰í•œë‹¤. `process.argv[1]`ì€ `node our.js` ë¥¼ ì‹¤í–‰í•˜ê¸° ë•Œë¬¸ì— `['node', 'our.js']`ì—ì„œ 1ë²ˆ ì¸ë±ìŠ¤ì— ìˆëŠ” `our.js`ì´ë‹¤. ê°’ì€ ì ˆëŒ€ê²½ë¡œë¡œ ë“¤ì–´ê°„ë‹¤.

### [internal/modules/run_main:](https://github.com/nodejs/node/blob/v16.x/lib/internal/modules/run_main.js#L74)

```js
...
function executeUserEntryPoint(main = process.argv[1]) {
  const resolvedMain = resolveMainPath(main);
  const useESMLoader = shouldUseESMLoader(resolvedMain);
  if (useESMLoader) {
    runMainESM(resolvedMain || main);
  } else {
    // Module._load is the monkey-patchable CJS module loader.
    Module._load(main, null, true);
  }
}
```

ì—¬ê¸°ì„œ `useESMLoader` ì¸ì§€ í™•ì¸í•˜ëŠ”ë°, ì§€ê¸ˆ ìš°ë¦¬ì˜ ê²½ìš°ì—ì„œëŠ” falseì´ë¯€ë¡œ `our.js`ë¥¼ ì¸ìë¡œ ì£¼ê³  `Module._load()`ë¥¼ ì‹¤í–‰í•˜ê²Œ ëœë‹¤. ìœ„ì˜ ì—ëŸ¬ì½”ë“œì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### [internal/modules/cjs/loader:](https://github.com/nodejs/node/blob/v16.x/lib/internal/modules/cjs/loader.js#L757)

```js
Module._load = function(request, parent, isMain) {
 let relResolveCacheIdentifier;
 ...

 const filename = Module._resolveFilename(request, parent, isMain);
 ...

 // Don't call updateChildren(), Module constructor already does.
 const module = cachedModule || new Module(filename, parent);
 ...

 if (isMain) {
   process.mainModule = module;
   module.id = '.';
 }
 ...

 if (parent !== undefined) {
   relativeResolveCache[relResolveCacheIdentifier] = filename;
 }
 ...

 let threw = true;

 try {
   module.load(filename);
   threw = false;
 } finally {
   ...
 }

 return module.exports;
};
```

`run_main`ì—ì„œ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œ ë‹¤ìŒê³¼ ê°™ì´ í˜¸ì¶œí–ˆë‹¤.

```js
Module._load(main /*process.argv[1]*/, null, true)
```

`const module = cachedModule || new Module(filename, parent);` ì—ì„œ ìš°ë¦¬ê°€ ì…ë ¥í•œ íŒŒì¼ì´ë¦„ì„ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡œìš´ module ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•œë‹¤. `isMain`ì€ trueì´ê¸° ë•Œë¬¸ì— `process.mainModule`ì— ìƒˆë¡œ ìƒì„±í•œ module ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë„£ëŠ”ë‹¤. ì´ë¥¼ í†µí•´ `global` ìŠ¤ì½”í”„ì— ìˆëŠ” `process`ì—ì„œ moduleì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ `module.load(filename);` ë¥¼ í˜¸ì¶œí•˜ê²Œ ëœë‹¤.

### [internal/modules/cjs/loader:](https://github.com/nodejs/node/blob/v16.x/lib/internal/modules/cjs/loader.js#L969)

```js
Module.prototype.load = function(filename) {
  ...

  const extension = findLongestRegisteredExtension(filename);
  ...

  Module._extensions[extension](this, filename);
  ...
};
```

`filename`ì—ì„œ í™•ì¥ìë¥¼ ë½‘ê³ , `Module._extensions[extension](this, filename)`ë¥¼ í˜¸ì¶œí•œë‹¤. `node our.js`ë¥¼ ì‹¤í–‰í–ˆê¸° ë•Œë¬¸ì— extensionì€ `js` ì´ë‹¤.

### [internal/modules/cjs/loader:](https://github.com/nodejs/node/blob/v16.x/lib/internal/modules/cjs/loader.js#L1110)

```js
Module._extensions['.js'] = function(module, filename) {
  // If already analyzed the source, then it will be cached.
  const cached = cjsParseCache.get(module);
  let content;
  if (cached?.source) {
    content = cached.source;
    cached.source = undefined;
  } else {
    content = fs.readFileSync(filename, 'utf8');
  }
  ...

  module._compile(content, filename);
};

```

`filename`ì„ í†µí•´ íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ì˜¤ê³  `content`ì— ì €ì¥í•œë‹¤. ê·¸ë¦¬ê³  `module._compile(content, filename);`ë¥¼ í˜¸ì¶œí•œë‹¤.

### [internal/modules/cjs/loader:](https://github.com/nodejs/node/blob/v16.x/lib/internal/modules/cjs/loader.js#L1055)

```js
Module.prototype._compile = function(content, filename) {
  ...

  const compiledWrapper = wrapSafe(filename, content, this);
  ...

  const dirname = path.dirname(filename);
  const require = makeRequireFunction(this, redirects);
  let result;
  const exports = this.exports;
  const thisValue = exports;
  const module = this;
  ...

  if (inspectorWrapper /* false now */ ) {
    ...

  } else {
    result = ReflectApply(compiledWrapper, thisValue,
                          [exports, require, module, filename, dirname]);
  }
  return result;
};
```

`content`ì™€ `filename`ì„ í†µí•´ `wrapSafe`ë¥¼ í˜¸ì¶œí•œë‹¤. ë­”ê°€ ì´ë¦„ì´ ìš°ë¦¬ê°€ ë‹µì´ ìˆì„ ê²ƒë§Œ ê°™ì€ ì´ë¦„ì´ë‹¤.

**[wrapSafe:](https://github.com/nodejs/node/blob/v16.x/lib/internal/modules/cjs/loader.js#L1055)**

```js
function wrapSafe(filename, content, cjsModuleInstance) {
  if (patched) {
    const wrapper = Module.wrap(content);
    return vm.runInThisContext(wrapper, {
      filename,
      lineOffset: 0,
      displayErrors: true,
      importModuleDynamically: async (specifier) => {
        const loader = asyncESM.esmLoader;
        return loader.import(specifier, normalizeReferrerURL(filename));
      },
    });
  }
  try {
    return vm.compileFunction(content, [
      'exports',
      'require',
      'module',
      '__filename',
      '__dirname',
    ], {
      filename,
      importModuleDynamically(specifier) {
        const loader = asyncESM.esmLoader;
        return loader.import(specifier, normalizeReferrerURL(filename));
      },
    });
  } catch (err) {
    ...

  }
}
```

ì½”ë“œ ìƒì— `Module`ì— `wrapper` í”„ë¡œí¼í‹°ë¥¼ ì •ì˜í•˜ë©´ì„œ `patched` ì˜ ê°’ì´ trueê°€ ëœë‹¤. `Module.wrap`ì„ í˜¸ì¶œí•˜ê³  wrapping ëœ í•¨ìˆ˜ë¥¼ `vm`ì—ì„œ ì‹¤í–‰í•œ í›„ ê·¸ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ëŠ” ì‹ì´ë‹¤.

**wrapper, wrap:**

```js
let wrap = function (script) {
  return Module.wrapper[0] + script + Module.wrapper[1]
}

const wrapper = ['(function (exports, require, module, __filename, __dirname) { ', '\n});']
```

![image](https://user-images.githubusercontent.com/51329156/152758635-d38c4c1d-cd48-4a15-b22a-f794ffced769.png)

ì°¾ì•˜ë‹¤ !!!! ìƒê°ë³´ë‹¤ í—ˆë¬´í•˜ê²Œ ë§Œë“¤ì–´ì£¼ê³  ìˆì—ˆë‹¤. ã…‹ã…‹ã…‹ã…‹ ê·¸ëƒ¥ íŒŒì¼ ë‚´ìš©(ì½”ë“œ)ë¥¼ í•¨ìˆ˜ë¡œ ê°ì‹¸ì¤Œìœ¼ë¡œì¨ moduleí™” í•˜ê³  ìˆì—ˆë‹¤. `wrap`ê³¼ `wrapper`ë¥¼ Moduleì— ì •ì˜í•˜ëŠ” ë¶€ë¶„ì€ ìƒëµ !

ë§ˆì§€ë§‰ìœ¼ë¡œ `Module._compile` ë‚´ë¶€ì ìœ¼ë¡œ ì„ ì–¸í–ˆë˜ `exports, require, module, filename, dirname`ì„ ì¸ìë¡œ ë„˜ê²¨ì£¼ë©° í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ê³  ê²°ê³¼ê°’ì„ ë¦¬í„´í•œë‹¤.

```js
// our.js
function a() {
  return a.caller
}
console.log(a().toString())

/* Result
function (exports, require, module, __filename, __dirname) {
    function a() {
        return a.caller
    }
    console.log(a().toString())
}
*/
```

ì´ì œì•¼ `our.js`ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ ì €ëŸ° ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ”ì§€ ì•Œê²Œ ë˜ì—ˆë‹¤ !!!

## ğŸ¤” `require` in `global` ??

ì¢€ ë” ìƒê°í•´ë³¼ë§Œ í•œ ê²Œ ìˆë‹¤. í‰ì†Œ nodejsë¥¼ ì‚¬ìš©í•˜ë‹¤ë³´ë©´ `require('fs')`, `require('express')` ë“±ë“± `require()`ì„ ì •~~ë§ ìì£¼ ì‚¬ìš©í•œë‹¤. **`require()` í•¨ìˆ˜ë¥¼ ì§€ì •í•´ì¤€ ì ì´ ì—†ëŠ”ë° ì–´ë–»ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œ?** ëŒ€ë¶€ë¶„ì˜ ê²½ìš°ëŠ” `global` ê°ì²´ì— ì„ ì–¸ë˜ì–´ ìˆì–´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ ! ê°€ ì •ë‹µì´ì§€ë§Œ `require`ì˜ ê²½ìš°ëŠ” ë‹¤ë¥´ë‹¤. ì•„ë˜ ì½”ë“œë¥¼ ì§ì ‘ ì‹¤í–‰í•´ë³´ì.

```js
console.log('require' in Object.getOwnPropertyNames(global)) // false
```

**ê·¸ëŸ¼ `global`ì—ë„ ì—†ëŠ” í•¨ìˆ˜ë¥¼ ì–´ë–»ê²Œ í˜¸ì¶œí•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆì—ˆë˜ ê±¸ê¹Œ?** ê·¸ ë‹µì´ ìœ„ì— ìˆë‹¤. Nodejsê°€ `our.js`ë¥¼ ì‹¤í–‰í•˜ë©´ nodejs í‘œì¤€(=CommonJSì˜ ëª…ì„¸)ì— ë”°ë¼ ì½”ë“œë¥¼ ëª¨ë“ˆí™” í•˜ê²Œ ë˜ê³ , ê·¸ ê³¼ì •ì—ì„œ ìš°ë¦¬ì˜ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•íƒœë¡œ ë³€í•˜ê²Œ ëœë‹¤.

```js
function (exports, require, module, __filename, __dirname) {
    // our code
}
```

`our code` ì½”ë“œì—ì„œ `exports`, `require` ë“±ì˜ íŒŒë¼ë¯¸í„°ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤. ê·¸ë¦¬ê³  ì € ê°’ë“¤ì€ `Module._compile`ì— ì„ ì–¸ë˜ì–´ ìˆë‹¤. ì¦‰ ìš°ë¦¬ê°€ í‰ì†Œ ì‚¬ìš©í•˜ëŠ” `require()` í•¨ìˆ˜ëŠ” `Module._compile`ì— ì •ì˜ë˜ì–´ ìˆëŠ” `require` í•¨ìˆ˜ ì¸ ê²ƒì´ë‹¤ !!!!

![image](https://gifburg.com/images/gifs/clapping/gifs/0013.gif)

ì§„ì§œ ì‹ ê¸°í•˜ë‹¤ ã…‹!ã…‹!ã…‹!ã…‹!ã…‹!ã…‹!

ê·¸ë˜ì„œ ìš°ë¦¬ëŠ” `require`ë¥¼ ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œë„ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

```js
function a() {
  return a.caller
}
console.log(a().arguments[1] == require) // true
```

## Conclusion

ë¸Œë¼ìš°ì €ì™€ nodejs ì¸í„°í”„ë¦¬í„°ì˜ ê²½ìš°ì—ëŠ” top-level scopeê°€ globalì´ë‹¤(ë¸Œë¼ìš°ì €ëŠ” window). ê·¸ë¦¬ê³  top-level scopeì—ì„œ `caller`ë¥¼ í˜¸ì¶œí•˜ë©´ `null`ì„ ë°˜í™˜í•œë‹¤. í•˜ì§€ë§Œ `node our.js`ë¥¼ ì‹¤í–‰í•˜ëŠ” ê²½ìš°ëŠ” nodejs í‘œì¤€ì— ë”°ë¼ ì½”ë“œë¥¼ ëª¨ë“ˆí™”í•˜ê²Œ ë˜ê³ , ìš°ë¦¬ ì½”ë“œëŠ” ê·¸ ëª¨ë“ˆ ì•ˆì—ì„œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— `caller`ë¥¼ í˜¸ì¶œì´ ê°€ëŠ¥í•˜ë‹¤. ëª¨ë“ˆì˜ `exports, require, module, __filename, __dirname` íŒŒë¼ë¯¸í„°ëŠ” ëª¨ë‘ global ë°–ì˜ ê°’ì´ê¸° ë•Œë¬¸ì— `global`ì— ìˆëŠ” ëª¨ë“  ê°’ì„ ì§€ìš°ë”ë¼ë„ `require`ëŠ” í˜¸ì¶œì´ ê°€ëŠ¥í•˜ë‹¤ !!

### Reference

> ğŸš€ https://github.com/nodejs/node
>
> ğŸš€ https://nodejs.org/en/docs/
